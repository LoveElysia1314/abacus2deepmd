#!/usr/bin/env python
"""
Script name: trajectory_analyser.py
Function: ABACUS trajectory analyzer
==================================================

Function:
---------
Batch analysis of STRU file sequences generated by ABACUS molecular dynamics simulation,
based on standardized distribution characteristics of interatomic distance vectors and recommended metrics,
to evaluate conformational diversity.

Core metrics (updated version):
-----------------------------
1. ConfVol: Conformational space volume (core diversity metric)
2. ANND: Average nearest neighbor distance (average nearest neighbor distance)
3. MPD: Mean pairwise distance (mean pairwise distance)
4. PCA explained variance ratios: Principal component variance contribution rates

All outputs are dimensionless standardized metrics, suitable for cross-system comparison.

Input structure:
---------------
Multiple system folders under current directory:
    struct_mol_<ID>_conf_<N>_T<T>K/
    └── OUT.ABACUS/
        └── STRU/
            ├── STRU_MD_0
            ├── STRU_MD_1
            └── ...

Output structure:
----------------
analysis_results/
├── struct_mol_<ID>/
│   ├── standardized_metrics_per_frame_<system>.csv    ← Single frame metrics + sampling results
│   ├── standardized_metrics_<system>.json             ← Aggregated metrics (no per-frame)
│   └── ... (merged analysis similar)
└── standardized_distribution_summary.csv               ← Summary comparison of all systems

Usage:
------
python trajectory_analyser.py [--include_h] [--max_workers N] [--sample_ratio R] [--sample_count N]

Dependencies:
-------------
numpy, scipy, stru_parser.py
"""

import logging

# Level 3: Import unified structural metrics module (for external use)
try:  # Soft dependency to avoid circular import risk
    from ..core.system_analyser import RMSDCalculator

    kabsch_align = RMSDCalculator.kabsch_align
    iterative_mean_structure = RMSDCalculator.iterative_mean_structure
    compute_rmsf = RMSDCalculator.compute_rmsf
except Exception:  # noqa: BLE001 - Broad exception catch, only degrades functionality
    kabsch_align = None  # type: ignore
    iterative_mean_structure = None  # type: ignore
    compute_rmsf = None  # type: ignore

    # Parse energy information

# Note: Logger configuration is now managed by main program, module only gets logger
logger = logging.getLogger(__name__)


# ---- Energy Parser (merged from force_energy_parser.py) ----

import os
import csv
from typing import Dict


def save_energies_to_csv(energies: Dict[int, float], output_dir: str):
    """Save parsed energies to CSV files.

    Args:
        energies: Dictionary of frame_id -> energy
        output_dir: Directory to save CSV files
    """
    os.makedirs(output_dir, exist_ok=True)
    for frame_id, energy in energies.items():
        csv_path = os.path.join(output_dir, f"frame_{frame_id}.csv")
        with open(csv_path, "w", newline="", encoding="utf-8") as csvfile:
            writer = csv.writer(csvfile)
            writer.writerow(["final_etot(eV)", energy])
    """Save parsed energies to CSV files.

    Args:
        energies: Dictionary of frame_id -> energy
        output_dir: Directory to save CSV files
    """
    os.makedirs(output_dir, exist_ok=True)
    for frame_id, energy in energies.items():
        csv_path = os.path.join(output_dir, f"frame_{frame_id}.csv")
        with open(csv_path, "w", newline="", encoding="utf-8") as csvfile:
            writer = csv.writer(csvfile)
            writer.writerow(["final_etot(eV)", energy])


def main():
    """Main function for standalone execution."""
    from ..io.stru_parser import StrUParser

    parser = StrUParser()
    log_file = os.path.join("OUT.ABACUS", "running_md.log")
    output_dir = os.path.join("analysis_results", "single_energy_results")
    energies = parser.parse_running_md_log(log_file)
    save_energies_to_csv(energies, output_dir)
    print(f"Frame energies saved to single-frame CSV files in {output_dir} folder.")


if __name__ == "__main__":
    main()
